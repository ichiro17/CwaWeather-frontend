<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>å°å¼µå ±æ°£è±¡ - ä¸­è·è·ªæ£’å…¨éšŠç‰ˆ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root {
    --accent: #FFB81C;
    --accent-2: #002D62;
    --accent-text: #002D62;
    --bg-gradient: linear-gradient(135deg, #FFB81C 0%, #002D62 100%);
    --surface: rgba(255, 255, 255, 0.15);
    --muted: #333;
    --glass: rgba(255, 255, 255, 0.25);
    --radius: 20px;
    --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.1);
    --shadow-heavy: 0 16px 48px rgba(0, 0, 0, 0.2);
}

* { box-sizing: border-box; }

body {
    margin: 0;
    padding: 0;
    font-family: 'Noto Sans TC', sans-serif;
    background: var(--bg-gradient);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
    transition: background 1.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* å¤©æ°£å‹•ç•«æ•ˆæœ */
#weatherEffects {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
    overflow: hidden;
}

.raindrop {
    position: absolute;
    width: 2px;
    height: 20px;
    background: linear-gradient(to bottom, rgba(255,255,255,0.3), rgba(255,255,255,0.8));
    animation: fall linear infinite;
}

@keyframes fall {
    to {
        transform: translateY(100vh);
    }
}

.sunray {
    position: absolute;
    width: 3px;
    height: 80px;
    background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.4));
    animation: shine 3s ease-in-out infinite;
    transform-origin: top center;
}

@keyframes shine {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.7; }
}

.cloud {
    position: absolute;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 100px;
    animation: drift linear infinite;
}

@keyframes drift {
    from { transform: translateX(-100px); }
    to { transform: translateX(calc(100vw + 100px)); }
}

#particleCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
    opacity: 0.15;
}

#appRoot {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 680px;
    padding: 0 16px 60px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.teams-bar-wrapper {
    width: 100%;
    position: sticky;
    top: 0;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 16px 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    transition: background 0.5s;
}

.teams-bar {
    width: 100%;
    max-width: 680px;
    padding: 0 16px;
    margin: 0 auto;
    display: flex;
    gap: 12px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    scrollbar-width: none;
}
.teams-bar::-webkit-scrollbar { display: none; }

.team-btn {
    min-width: 64px;
    height: 64px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 28px;
    box-shadow: var(--shadow-soft);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.team-btn:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: var(--shadow-heavy);
}

.team-btn.active {
    background: rgba(255, 255, 255, 0.95);
    border-color: var(--accent);
    box-shadow: 0 0 0 4px var(--accent-2), var(--shadow-heavy);
    transform: scale(1.15);
}

.app-title {
    width: 100%;
    padding: 32px 0 24px;
    color: white;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    position: relative;
}

.app-title h1 {
    font-size: clamp(1.8rem, 4vw, 2.8rem);
    font-weight: 900;
    text-align: center;
    margin: 0 0 8px 0;
}

.team-name-badge {
    text-align: center;
    font-size: 1.1rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.95);
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    border-radius: 999px;
    padding: 8px 24px;
    display: inline-block;
    margin: 0 auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
}

.hero-card {
    width: 100%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius);
    padding: 32px 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-shadow: var(--shadow-heavy);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 28px;
}

.hero-icon {
    font-size: 100px;
    filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.2));
    margin-bottom: 16px;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.hero-temp {
    font-size: clamp(3rem, 8vw, 5rem);
    font-weight: 900;
    color: white;
    text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    line-height: 1;
}

.hero-weather-desc {
    font-size: 1.4rem;
    color: rgba(255, 255, 255, 0.9);
    margin-top: 8px;
    font-weight: 700;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.hero-minmax-temp {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 12px;
}

h2 {
    width: 100%;
    color: white;
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0 0 16px 0;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.future-forecasts {
    width: 100%;
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 12px;
    margin-bottom: 28px;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.5) transparent;
}

.future-forecasts::-webkit-scrollbar {
    height: 8px;
}
.future-forecasts::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 4px;
}

.mini-card {
    min-width: 100px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
    box-shadow: var(--shadow-soft);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: slideIn 0.5s ease-out backwards;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.mini-card:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: var(--shadow-heavy);
    border-color: rgba(255, 255, 255, 0.6);
}

.mini-card-time {
    font-size: 0.9rem;
    font-weight: 700;
    color: white;
    margin-bottom: 8px;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
}

.mini-card-icon {
    font-size: 36px;
    margin: 4px 0;
}

.mini-card-temp {
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
    margin-top: 8px;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
}

.mini-card-pop {
    font-size: 0.85rem;
    margin-top: 4px;
    color: rgba(255, 255, 255, 0.8);
}

.advice-card {
    width: 100%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(15px);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow-soft);
    margin-bottom: 28px;
    border-left: 6px solid rgba(255, 255, 255, 0.6);
    display: flex;
    align-items: flex-start;
    gap: 16px;
    transition: all 0.3s ease;
}

.advice-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-heavy);
}

.advice-icon {
    font-size: 48px;
    flex-shrink: 0;
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
}

.advice-content h3 {
    margin: 0 0 8px;
    font-size: 1.2rem;
    color: white;
    font-weight: 700;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
}

.advice-content p {
    margin: 0;
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.9);
    line-height: 1.6;
}

.meta-info {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    padding: 0 4px;
}

.refresh-btn {
    padding: 10px 20px;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 999px;
    cursor: pointer;
    font-size: 0.9rem;
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-weight: 700;
}

.refresh-btn:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
}

#loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #FFB81C 0%, #002D62 100%);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease;
}

#loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

#loading-message {
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

#toast-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.toast {
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    max-width: 80vw;
    text-align: center;
    font-size: 0.95rem;
}

.toast.show {
    opacity: 1;
    transform: translateY(-10px);
}

footer {
    width: 100%;
    max-width: 680px;
    text-align: center;
    padding: 20px 16px;
    margin: 20px auto 0;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.8);
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
}

footer a {
    color: white;
    text-decoration: none;
    font-weight: 700;
    border-bottom: 1px solid rgba(255, 255, 255, 0.5);
}

/* æº«åº¦è¶¨å‹¢åœ– */
.chart-container {
    width: 100%;
    height: 200px;
    margin-bottom: 28px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(15px);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow-soft);
}

#tempChart {
    width: 100%;
    height: 100%;
}

/* ç©¿æ­å»ºè­°åœ–ç¤º */
.clothing-suggestions {
    width: 100%;
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 16px;
    flex-wrap: wrap;
}

.clothing-item {
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 12px 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    min-width: 80px;
    box-shadow: var(--shadow-soft);
    transition: all 0.3s ease;
    animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) backwards;
}

.clothing-item:nth-child(1) { animation-delay: 0.1s; }
.clothing-item:nth-child(2) { animation-delay: 0.15s; }
.clothing-item:nth-child(3) { animation-delay: 0.2s; }
.clothing-item:nth-child(4) { animation-delay: 0.25s; }

@keyframes popIn {
    from {
        opacity: 0;
        transform: scale(0.5);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.clothing-item:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: var(--shadow-heavy);
}

.clothing-icon {
    font-size: 32px;
}

.clothing-label {
    font-size: 0.85rem;
    color: white;
    font-weight: 600;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
}

/* æ”¶è—æŒ‰éˆ• */
.favorite-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 0.3s ease;
    z-index: 100;
}

.favorite-btn:hover {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.5);
}

.favorite-btn.active {
    background: rgba(255, 215, 0, 0.9);
    border-color: gold;
    animation: heartbeat 0.6s ease;
}

@keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    25% { transform: scale(1.3); }
    50% { transform: scale(1.1); }
    75% { transform: scale(1.25); }
}

@media (max-width: 480px) {
    .hero-card { padding: 24px 16px; }
    .app-title h1 { font-size: 1.6rem; }
    .chart-container { height: 160px; padding: 12px; }
    .clothing-item { min-width: 70px; padding: 10px 12px; }
}
</style>
</head>
<body>

<div id="weatherEffects"></div>

<canvas id="particleCanvas"></canvas>

<div id="loading">
    <div id="loading-spinner"></div>
    <div id="loading-message">è¼‰å…¥ä¸­...</div>
</div>

<div class="teams-bar-wrapper">
    <nav class="teams-bar" id="teamsBar"></nav>
</div>

<main id="appRoot" style="display: none;">
    <div class="app-title">
        <h1>å°å¼µå ±æ°£è±¡:<span id="currentTeamEmoji"></span><span id="currentTeamCity">è‡ºä¸­å¸‚</span></h1>
        <div class="team-name-badge" id="teamNameBadge">ä¸­ä¿¡å…„å¼Ÿ</div>
        <button class="favorite-btn" id="favoriteBtn" title="è¨­ç‚ºé è¨­çƒéšŠ">â­</button>
    </div>

    <div class="hero-card">
        <div class="hero-icon" id="heroIcon">â˜€ï¸</div>
        <div class="hero-temp" id="heroTemp">28Â°</div>
        <div class="hero-weather-desc" id="heroWeatherDesc">å¤šé›²æ™‚æ™´</div>
        <div class="hero-minmax-temp" id="heroMinMaxTemp">æœ€ä½ 24Â° / æœ€é«˜ 32Â°</div>
    </div>

    <h2>ğŸ“Š æº«åº¦è¶¨å‹¢</h2>
    <div class="chart-container">
        <canvas id="tempChart"></canvas>
    </div>

    <h2>36 å°æ™‚é å ±</h2>
    <div class="future-forecasts" id="futureForecasts"></div>

    <h2>ç©¿æ­èˆ‡å»ºè­°</h2>
    <div class="advice-card">
        <div class="advice-icon" id="adviceIcon">ğŸ‘•</div>
        <div class="advice-content">
            <h3 id="adviceTitle">èˆ’é©å®œäºº</h3>
            <p id="adviceText">å¤©æ°£æº«å’Œ,å¯è‡ªç”±é¸æ“‡èˆ’é©çš„ç©¿è‘—ã€‚</p>
        </div>
    </div>

    <div class="clothing-suggestions" id="clothingSuggestions"></div>

    <div class="meta-info">
        <span id="updateTime">æ›´æ–°æ™‚é–“:è¼‰å…¥ä¸­</span>
        <button class="refresh-btn" id="refreshBtn">
            <span>â†»</span>
            é‡æ–°æ•´ç†
        </button>
    </div>
</main>

<div id="toast-container"></div>

<footer>
    <p>è³‡æ–™ä¾†æº:ä¸­å¤®æ°£è±¡ç½² | æœ¬ç¶²ç«™ç‚ºå±•ç¤ºç”¨é€”</p>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
const API_BASE_URL = 'http://localhost:3000';
const STORAGE_KEY = 'favorite_team';

const TEAMS = [
    { id: 'brothers', name: 'ä¸­ä¿¡å…„å¼Ÿ', city: 'è‡ºä¸­å¸‚', cityKey: 'taichung', emoji: 'ğŸ˜', 
      gradient: 'linear-gradient(135deg, #FFB81C 0%, #002D62 100%)',
      primary: '#FFB81C', secondary: '#002D62' },
    { id: 'monkeys', name: 'æ¨‚å¤©æ¡ƒçŒ¿', city: 'æ¡ƒåœ’å¸‚', cityKey: 'taoyuan', emoji: 'ğŸµ', 
      gradient: 'linear-gradient(135deg, #D50A20 0%, #8B0000 100%)',
      primary: '#D50A20', secondary: '#8B0000' },
    { id: 'lions', name: 'çµ±ä¸€ç…', city: 'è‡ºå—å¸‚', cityKey: 'tainan', emoji: 'ğŸ¦', 
      gradient: 'linear-gradient(135deg, #FF7700 0%, #00548E 100%)',
      primary: '#FF7700', secondary: '#00548E' },
    { id: 'guards', name: 'å¯Œé‚¦æ‚å°‡', city: 'æ–°åŒ—å¸‚', cityKey: 'newtaipei', emoji: 'ğŸ”±', 
      gradient: 'linear-gradient(135deg, #0070A0 0%, #E6004C 100%)',
      primary: '#0070A0', secondary: '#E6004C' },
    { id: 'dragons', name: 'å‘³å…¨é¾', city: 'è‡ºåŒ—å¸‚', cityKey: 'taipei', emoji: 'ğŸ‰', 
      gradient: 'linear-gradient(135deg, #E3002C 0%, #000000 100%)',
      primary: '#E3002C', secondary: '#000000' },
    { id: 'hawkes', name: 'å°é‹¼é›„é·¹', city: 'é«˜é›„å¸‚', cityKey: 'kaohsiung', emoji: 'ğŸ¦…', 
      gradient: 'linear-gradient(135deg, #1E4936 0%, #6B8E23 100%)',
      primary: '#1E4936', secondary: '#6B8E23' },
];

let currentTeam = 0;
let particles = [];
let canvas, ctx;
let weatherCache = {};
let tempChart = null;

// Canvas ç²’å­èƒŒæ™¯
function initParticles() {
    canvas = document.getElementById('particleCanvas');
    ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    particles = [];
    for (let i = 0; i < 30; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5,
            size: Math.random() * 30 + 20,
            emoji: TEAMS[currentTeam].emoji
        });
    }
    animateParticles();
}

function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;

        if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
        if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

        ctx.font = `${p.size}px Arial`;
        ctx.fillText(p.emoji, p.x, p.y);
    });

    requestAnimationFrame(animateParticles);
}

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

function showToast(msg, type = 'info', duration = 3000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

function getEmoji(desc) {
    if (desc.includes('é›¨')) return 'ğŸŒ§ï¸';
    if (desc.includes('é›·')) return 'â›ˆï¸';
    if (desc.includes('æ™´')) return 'â˜€ï¸';
    if (desc.includes('é›²')) return 'â˜ï¸';
    if (desc.includes('é™°')) return 'â˜ï¸';
    if (desc.includes('éœ§')) return 'ğŸŒ«ï¸';
    return 'â“';
}

function getAdvice(weather, comfort) {
    if (weather.includes('é›·')) return { title: 'é›·é›¨è­¦å ±', text: 'è«‹é¿å…æˆ¶å¤–æ´»å‹•,ä¸¦æ”œå¸¶é›¨å…·ã€‚', icon: 'â›ˆï¸' };
    if (weather.includes('å¤§é›¨')) return { title: 'å¤§é›¨ç‰¹å ±', text: 'è«‹æ³¨æ„è·¯é¢ç©æ°´,å»ºè­°ç©¿è‘—é›¨è¡£å’Œé˜²æ°´é‹ã€‚', icon: 'â˜”' };
    if (weather.includes('é›¨')) return { title: 'è¨˜å¾—å¸¶å‚˜', text: 'ä»Šæ—¥æœ‰é™é›¨æ©Ÿæœƒ,å¤–å‡ºè«‹æ”œå¸¶é›¨å…·ã€‚', icon: 'ğŸŒ‚' };
    if (weather.includes('æ™´')) return { title: 'é™½å…‰æ™®ç…§', text: 'ç´«å¤–ç·šå¼·,è«‹åšå¥½é˜²æ›¬,å»ºè­°ç©¿è‘—è¼•è–„é€æ°£è¡£ç‰©ã€‚', icon: 'ğŸ˜' };
    if (comfort && comfort.includes('å¯’å†·')) return { title: 'æ³¨æ„ä¿æš–', text: 'å¤©æ°£è¼ƒå†·,å»ºè­°å¤šç©¿ä¸€ä»¶å¤–å¥—ã€‚', icon: 'ğŸ§¥' };
    if (comfort && comfort.includes('æ‚¶ç†±')) return { title: 'æ³¨æ„é˜²æš‘', text: 'å¤©æ°£æ‚¶ç†±,è«‹å¤šè£œå……æ°´åˆ†,é¿å…ä¸­æš‘ã€‚', icon: 'ğŸ’§' };
    return { title: 'èˆ’é©å®œäºº', text: 'å¤©æ°£æº«å’Œ,å¯è‡ªç”±é¸æ“‡èˆ’é©çš„ç©¿è‘—ã€‚', icon: 'ğŸ‘•' };
}

// å¤©æ°£å‹•ç•«æ•ˆæœ
function createWeatherEffect(weather) {
    const container = document.getElementById('weatherEffects');
    container.innerHTML = '';

    if (weather.includes('é›¨')) {
        // é›¨æ»´æ•ˆæœ
        for (let i = 0; i < 50; i++) {
            const drop = document.createElement('div');
            drop.className = 'raindrop';
            drop.style.left = Math.random() * 100 + '%';
            drop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
            drop.style.animationDelay = Math.random() * 2 + 's';
            container.appendChild(drop);
        }
    } else if (weather.includes('æ™´')) {
        // é™½å…‰æ•ˆæœ
        for (let i = 0; i < 10; i++) {
            const ray = document.createElement('div');
            ray.className = 'sunray';
            ray.style.left = (i * 10 + Math.random() * 10) + '%';
            ray.style.top = '-80px';
            ray.style.animationDelay = Math.random() * 3 + 's';
            ray.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
            container.appendChild(ray);
        }
    } else if (weather.includes('é›²') || weather.includes('é™°')) {
        // é›²æœµæ•ˆæœ
        for (let i = 0; i < 5; i++) {
            const cloud = document.createElement('div');
            cloud.className = 'cloud';
            cloud.style.width = (Math.random() * 80 + 60) + 'px';
            cloud.style.height = (Math.random() * 40 + 30) + 'px';
            cloud.style.top = (Math.random() * 40) + '%';
            cloud.style.animationDuration = (Math.random() * 20 + 30) + 's';
            cloud.style.animationDelay = (i * 5) + 's';
            container.appendChild(cloud);
        }
    }
}

// ç©¿æ­å»ºè­°
function getClothingSuggestions(temp, weather) {
    const suggestions = [];
    const avgTemp = typeof temp === 'number' ? temp : parseInt(temp);

    if (avgTemp < 15) {
        suggestions.push({ icon: 'ğŸ§¥', label: 'åšå¤–å¥—' });
        suggestions.push({ icon: 'ğŸ§£', label: 'åœå·¾' });
        suggestions.push({ icon: 'ğŸ‘–', label: 'é•·è¤²' });
    } else if (avgTemp < 20) {
        suggestions.push({ icon: 'ğŸ§¥', label: 'è–„å¤–å¥—' });
        suggestions.push({ icon: 'ğŸ‘•', label: 'é•·è¢–' });
        suggestions.push({ icon: 'ğŸ‘–', label: 'é•·è¤²' });
    } else if (avgTemp < 25) {
        suggestions.push({ icon: 'ğŸ‘•', label: 'é•·è¢–' });
        suggestions.push({ icon: 'ğŸ‘–', label: 'é•·è¤²' });
    } else if (avgTemp < 30) {
        suggestions.push({ icon: 'ğŸ‘•', label: 'çŸ­è¢–' });
        suggestions.push({ icon: 'ğŸ©³', label: 'çŸ­è¤²' });
    } else {
        suggestions.push({ icon: 'ğŸ‘•', label: 'çŸ­è¢–' });
        suggestions.push({ icon: 'ğŸ©³', label: 'çŸ­è¤²' });
        suggestions.push({ icon: 'ğŸ§¢', label: 'é®é™½å¸½' });
    }

    if (weather.includes('é›¨')) {
        suggestions.push({ icon: 'â˜‚ï¸', label: 'é›¨å‚˜' });
    }

    if (weather.includes('æ™´')) {
        suggestions.push({ icon: 'ğŸ•¶ï¸', label: 'å¤ªé™½çœ¼é¡' });
    }

    return suggestions.slice(0, 4);
}

function renderClothingSuggestions(temp, weather) {
    const container = document.getElementById('clothingSuggestions');
    const suggestions = getClothingSuggestions(temp, weather);
    
    container.innerHTML = suggestions.map((item, idx) => `
        <div class="clothing-item" style="animation-delay: ${idx * 0.05}s">
            <div class="clothing-icon">${item.icon}</div>
            <div class="clothing-label">${item.label}</div>
        </div>
    `).join('');
}

// æº«åº¦è¶¨å‹¢åœ–
function createTempChart(forecasts) {
    const ctx = document.getElementById('tempChart');
    if (!ctx) return;

    const labels = forecasts.map(f => formatTime(f.startTime).split(' ')[1]);
    const temps = forecasts.map(f => Math.round((parseInt(f.minTemp) + parseInt(f.maxTemp)) / 2));
    
    const team = TEAMS[currentTeam];
    
    if (tempChart) {
        tempChart.destroy();
    }

    tempChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'æº«åº¦ (Â°C)',
                data: temps,
                borderColor: 'rgba(255, 255, 255, 0.9)',
                backgroundColor: 'rgba(255, 255, 255, 0.2)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: 'white',
                pointBorderColor: team.primary,
                pointBorderWidth: 2,
                pointHoverRadius: 7,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + 'Â°C';
                        }
                    }
                }
            },
            scales: {
                y: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.9)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        callback: function(value) {
                            return value + 'Â°';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)',
                        drawBorder: false
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.9)',
                        font: {
                            size: 11,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        drawBorder: false
                    }
                }
            }
        }
    });
}

// LocalStorage ç®¡ç†
function saveFavoriteTeam(teamIndex) {
    localStorage.setItem(STORAGE_KEY, teamIndex);
    showToast('å·²è¨­ç‚ºé è¨­çƒéšŠ ' + TEAMS[teamIndex].emoji, 'info');
}

function getFavoriteTeam() {
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved !== null ? parseInt(saved) : null;
}

function updateFavoriteButton() {
    const btn = document.getElementById('favoriteBtn');
    const favorite = getFavoriteTeam();
    
    if (favorite === currentTeam) {
        btn.classList.add('active');
        btn.textContent = 'â­';
        btn.title = 'å·²æ˜¯é è¨­çƒéšŠ';
    } else {
        btn.classList.remove('active');
        btn.textContent = 'â˜†';
        btn.title = 'è¨­ç‚ºé è¨­çƒéšŠ';
    }
}

function formatTime(timeStr) {
    const date = new Date(timeStr);
    return `${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:00`;
}

async function fetchWeather(cityKey) {
    try {
        showLoading(true);
        document.getElementById('loading-message').textContent = 'è¼‰å…¥å¤©æ°£è³‡æ–™ä¸­...';
        
        const response = await fetch(`${API_BASE_URL}/api/weather/${cityKey}`);
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.message || 'ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™');
        }
        
        weatherCache[cityKey] = result.data;
        return result.data;
    } catch (error) {
        console.error('å–å¾—å¤©æ°£å¤±æ•—:', error);
        showToast('ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™,è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦', 'error', 5000);
        throw error;
    } finally {
        showLoading(false);
    }
}

function renderWeather(data) {
    if (!data || !data.forecasts || data.forecasts.length === 0) {
        showToast('å¤©æ°£è³‡æ–™æ ¼å¼éŒ¯èª¤', 'error');
        return;
    }

    const current = data.forecasts[0];
    
    // æ›´æ–°ä¸»è¦å¤©æ°£å¡ç‰‡
    const avgTemp = Math.round((parseInt(current.minTemp) + parseInt(current.maxTemp)) / 2);
    const weatherEmoji = getEmoji(current.weather);
    
    document.getElementById('heroIcon').textContent = weatherEmoji;
    document.getElementById('heroTemp').textContent = `${avgTemp}Â°`;
    document.getElementById('heroWeatherDesc').textContent = current.weather;
    document.getElementById('heroMinMaxTemp').textContent = 
        `æœ€ä½ ${current.minTemp}Â° / æœ€é«˜ ${current.maxTemp}Â°`;
    
    // å¤©æ°£å‹•ç•«æ•ˆæœ
    createWeatherEffect(current.weather);
    
    // æº«åº¦è¶¨å‹¢åœ–
    createTempChart(data.forecasts);
    
    // æ›´æ–° 36 å°æ™‚é å ±
    const container = document.getElementById('futureForecasts');
    container.innerHTML = '';
    
    data.forecasts.forEach((forecast, idx) => {
        const card = document.createElement('div');
        card.className = 'mini-card';
        card.style.animationDelay = `${idx * 0.05}s`;
        
        const avgTemp = Math.round((parseInt(forecast.minTemp) + parseInt(forecast.maxTemp)) / 2);
        const icon = getEmoji(forecast.weather);
        
        card.innerHTML = `
            <div class="mini-card-time">${formatTime(forecast.startTime)}</div>
            <div class="mini-card-icon">${icon}</div>
            <div class="mini-card-temp">${avgTemp}Â°</div>
            <div class="mini-card-pop">${forecast.rain}%</div>
        `;
        container.appendChild(card);
    });
    
    // æ›´æ–°å»ºè­°å¡ç‰‡
    const advice = getAdvice(current.weather, current.comfort);
    document.getElementById('adviceIcon').textContent = advice.icon;
    document.getElementById('adviceTitle').textContent = advice.title;
    document.getElementById('adviceText').textContent = advice.text;
    
    // ç©¿æ­å»ºè­°
    renderClothingSuggestions(avgTemp, current.weather);
    
    // æ›´æ–°æ™‚é–“
    const now = new Date().toLocaleString('zh-TW', { 
        year: 'numeric',
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('updateTime').textContent = `æ›´æ–°æ™‚é–“:${now}`;
}

async function updateTeam(idx) {
    currentTeam = idx;
    const team = TEAMS[idx];
    
    // æ›´æ–°ä¸»é¡Œè‰²
    document.body.style.background = team.gradient;
    document.querySelector('.teams-bar-wrapper').style.background = 'rgba(255, 255, 255, 0.1)';
    
    // æ›´æ–° CSS è®Šæ•¸ä»¥å½±éŸ¿åœ–è¡¨é¡è‰²
    document.documentElement.style.setProperty('--accent', team.primary);
    document.documentElement.style.setProperty('--accent-2', team.secondary);
    
    document.getElementById('currentTeamEmoji').textContent = team.emoji;
    document.getElementById('currentTeamCity').textContent = team.city;
    document.getElementById('teamNameBadge').textContent = team.name;
    
    document.querySelectorAll('.team-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === idx);
    });

    particles.forEach(p => p.emoji = team.emoji);
    
    updateFavoriteButton();
    
    try {
        let weatherData = weatherCache[team.cityKey];
        if (!weatherData) {
            weatherData = await fetchWeather(team.cityKey);
        }
        renderWeather(weatherData);
    } catch (error) {
        console.error('æ›´æ–°çƒéšŠå¤©æ°£å¤±æ•—:', error);
    }
}

function buildTeamButtons() {
    const bar = document.getElementById('teamsBar');
    TEAMS.forEach((team, idx) => {
        const btn = document.createElement('button');
        btn.className = 'team-btn';
        btn.textContent = team.emoji;
        btn.onclick = () => updateTeam(idx);
        bar.appendChild(btn);
    });
}

document.getElementById('refreshBtn').addEventListener('click', async () => {
    const team = TEAMS[currentTeam];
    delete weatherCache[team.cityKey];
    showToast('é‡æ–°è¼‰å…¥å¤©æ°£è³‡æ–™ä¸­...', 'info');
    await updateTeam(currentTeam);
    showToast('å¤©æ°£è³‡æ–™å·²æ›´æ–°', 'info');
});

// æ”¶è—æŒ‰éˆ•äº‹ä»¶
document.getElementById('favoriteBtn').addEventListener('click', () => {
    const favorite = getFavoriteTeam();
    
    if (favorite === currentTeam) {
        // å–æ¶ˆæ”¶è—
        localStorage.removeItem(STORAGE_KEY);
        showToast('å·²å–æ¶ˆé è¨­çƒéšŠ', 'info');
    } else {
        // è¨­ç‚ºæ”¶è—
        saveFavoriteTeam(currentTeam);
    }
    
    updateFavoriteButton();
});

async function init() {
    buildTeamButtons();
    initParticles();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰é è¨­çƒéšŠ
    const favoriteTeam = getFavoriteTeam();
    const initialTeam = favoriteTeam !== null ? favoriteTeam : 0;
    
    setTimeout(async () => {
        document.getElementById('appRoot').style.display = 'flex';
        await updateTeam(initialTeam);
        
        if (favoriteTeam !== null) {
            showToast('å·²è¼‰å…¥æ‚¨çš„é è¨­çƒéšŠ ' + TEAMS[favoriteTeam].emoji, 'info', 2000);
        }
    }, 800);
}

init();
</script>

</body>
</html>
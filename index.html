<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Â∞èÂºµÂ†±Ê∞£Ë±° - ‰∏≠ËèØËÅ∑Ê£íÂÖ®ÈöäÁâàÔºàÊîπËâØÁâàÔºâ</title>

  <!-- font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    /* ========== CSS VARIABLES & RESET ========== */
    :root{
      --bg: linear-gradient(135deg,#fff,#f8f8f8);
      --surface: rgba(255,255,255,0.95);
      --muted: #666;
      --glass: rgba(255,255,255,0.25);
      --radius: 16px;
      --accent: #FFB81C; /* default team color (brothers) */
      --accent-2: #002D62;
      --accent-text: #002D62;
      --team-emoji: "üêò";
      --card-border: 3px solid var(--accent);
      --max-width: 680px;
      --shadow-soft: 0 8px 24px rgba(0,0,0,0.12);
      --shadow-sm: 0 3px 8px rgba(0,0,0,0.10);
    }

    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      font-family: 'Noto Sans TC', sans-serif;
      color:#1A1A1A;
      background:var(--bg);
      min-height:100vh;
      transition:background .45s ease, color .3s ease;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:28px;
    }

    /* dark mode fallback */
    @media (prefers-color-scheme: dark) {
      :root { --bg: linear-gradient(135deg,#0f1720,#0b1116); --surface: rgba(10,10,10,0.75); --muted:#bfc8d6; }
      body { color:#f3f6fb; }
    }

    .app {
      max-width:var(--max-width);
      margin:20px auto;
      padding:18px;
    }

    /* ========== STATUS BAR ========== */
    .status-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-radius:12px;
      background: linear-gradient(135deg, rgba(0,0,0,0.08), rgba(255,255,255,0.02));
      backdrop-filter: blur(8px);
      border-left: 6px solid var(--accent);
      box-shadow: var(--shadow-sm);
      position:sticky;
      top:12px;
      z-index:60;
    }
    .location-pill{
      background:var(--accent);
      color:var(--accent-text);
      padding:8px 16px;
      border-radius:22px;
      font-weight:900;
      transform:skewX(-5deg);
      border:2px solid rgba(255,255,255,0.5);
      letter-spacing:1px;
      display:inline-block;
    }
    .update-pill{
      font-size:0.86rem;
      color:var(--accent-text);
      background: rgba(255,255,255,0.12);
      padding:6px 12px;
      border-radius:14px;
      font-weight:700;
      border:1px solid rgba(0,0,0,0.06);
    }

    /* ========== TITLE ========== */
    .app-title{ text-align:center; margin:18px 0 8px; position:relative; }
    .app-title h1{
      font-size: clamp(1.6rem, 3.8vw, 2.6rem);
      font-weight:900;
      color:var(--accent);
      text-shadow: 2px 2px 0 var(--accent-2), 4px 4px 0 rgba(0,0,0,0.12);
      transform:skewY(-2deg);
      letter-spacing:3px;
    }
    .app-subtitle{
      font-size:0.86rem;
      color:var(--muted);
      font-weight:700;
      margin-top:6px;
      letter-spacing:1.5px;
    }

    /* ========== TEAM SELECTOR ========== */
    .team-selector{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      margin:16px 0;
      padding:12px;
      background: rgba(0,0,0,0.03);
      border-radius:12px;
    }
    .team-btn{
      padding:10px 8px;
      border-radius:12px;
      font-weight:900;
      font-size:0.92rem;
      cursor:pointer;
      border:2px solid rgba(0,0,0,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.35));
      transition:transform .18s ease, box-shadow .18s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .team-btn:hover{ transform:translateY(-4px); box-shadow:var(--shadow-sm); }
    .team-btn:focus-visible{
      outline: 3px solid var(--accent);
      outline-offset: 3px;
      transform:translateY(-2px);
    }
    .team-btn.active{
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.9));
      border-color: white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      transform:scale(1.04);
    }

    /* ========== HERO CARD ========== */
    .hero-card{
      background:var(--surface);
      border-radius:20px;
      padding:24px;
      text-align:center;
      box-shadow:var(--shadow-soft);
      border:var(--card-border);
      position:relative;
      overflow:hidden;
      transition:transform .35s ease, opacity .35s ease;
    }
    .hero-card::before{
      content: var(--team-emoji);
      position:absolute;
      font-size:12rem;
      opacity:0.03;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%) rotate(8deg);
      pointer-events:none;
    }
    .hero-period{
      position:absolute;
      top:-10px;
      left:50%;
      transform:translateX(-50%) skewX(-5deg);
      background:var(--accent);
      color:var(--accent-text);
      padding:8px 22px;
      border-radius:24px;
      font-weight:900;
      border:3px solid rgba(255,255,255,0.9);
      box-shadow: var(--shadow-sm);
      z-index:2;
    }
    .hero-temp-container{
      display:flex;
      flex-direction:row;
      justify-content:center;
      align-items:center;
      gap:18px;
      margin:18px 0;
      z-index:2;
    }
    .hero-icon{
      font-size:clamp(3.2rem,7vw,5.2rem);
      filter:drop-shadow(0 8px 18px rgba(0,0,0,0.12));
      animation: float 4s ease-in-out infinite;
    }
    @keyframes float{
      0%,100%{ transform:translateY(0) }
      50%{ transform:translateY(-8px) }
    }
    .hero-temp{
      font-size: clamp(2.2rem, 6vw, 4.6rem);
      font-weight:900;
      color:var(--accent);
      line-height:1;
      text-shadow: 1px 1px 0 var(--accent-2), 3px 3px 0 rgba(0,0,0,0.08);
      transform:skewY(-2deg);
      transition: transform .25s ease;
    }
    .hero-desc{
      font-size:1.2rem;
      color:#1A1A1A;
      margin-bottom:10px;
      font-weight:900;
      z-index:2;
    }

    /* ========== ADVICE GRID ========== */
    .advice-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:14px;
      padding-top:14px;
      border-top:3px dashed var(--accent);
    }
    .advice-item{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:12px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
      border:2px solid rgba(0,0,0,0.04);
      box-shadow:var(--shadow-sm);
      transition: transform .18s ease;
    }
    .advice-item:hover{ transform:translateY(-4px) }
    .advice-icon{ font-size:2.2rem; margin-bottom:6px; filter:drop-shadow(0 3px 6px rgba(0,0,0,0.12)); }
    .advice-text{ font-weight:900; color:var(--accent); font-size:1.05rem; }
    .advice-subtext{ font-size:0.78rem; color:var(--muted); font-weight:800; margin-top:6px; }

    /* ========== SCROLL / MINI CARDS ========== */
    .section-title{
      font-size:1.12rem;
      color:var(--accent);
      font-weight:900;
      margin:18px 4px 10px;
      display:inline-block;
      padding:8px 12px;
      border-left:5px solid var(--accent);
      background: rgba(0,0,0,0.04);
      border-radius:10px;
      transform:skewX(-3deg);
    }
    .scroll-wrap{ position:relative; margin-top:6px; }
    .scroll-container{
      display:flex;
      overflow-x:auto;
      gap:14px;
      padding:12px 6px 18px;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) rgba(255,255,255,0.2);
    }
    .scroll-container::-webkit-scrollbar { height:8px }
    .scroll-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.04); border-radius:10px }
    .scroll-container::-webkit-scrollbar-thumb { background:var(--accent); border-radius:10px }

    .mini-card{
      min-width:150px;
      background:var(--surface);
      border-radius:14px;
      padding:14px 12px;
      text-align:center;
      border:2px solid rgba(0,0,0,0.04);
      flex-shrink:0;
      box-shadow:var(--shadow-sm);
      transition: transform .18s ease;
    }
    .mini-card:hover{ transform:translateY(-6px) }
    .mini-time{
      display:inline-block;
      background:var(--accent);
      color:var(--accent-text);
      padding:6px 12px;
      border-radius:12px;
      font-weight:900;
      font-size:0.9rem;
      margin-bottom:10px;
    }
    .mini-icon{ font-size:2.6rem; margin:8px 0; }
    .mini-temp{ font-weight:900; font-size:1.05rem; }
    .mini-rain{ font-size:0.9rem; color:#2196F3; margin-top:7px; font-weight:800 }

    /* arrow hint */
    .scroll-arrow{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:40px;height:40px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.06);
      backdrop-filter: blur(4px);
      z-index:30;
      pointer-events:none;
      opacity:0;
      transition:opacity .28s ease, transform .28s ease;
    }
    .scroll-arrow.visible{ opacity:1; pointer-events:auto }
    .scroll-arrow.left{ left:8px; transform:translateY(-50%) translateX(0) }
    .scroll-arrow.right{ right:8px; transform:translateY(-50%) translateX(0) }

    /* refresh floating button */
    .refresh-btn{
      position:fixed;right:22px;bottom:22px;width:56px;height:56px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:var(--accent); color:var(--accent-text); border:3px solid white;
      box-shadow:0 8px 24px rgba(0,0,0,0.18); cursor:pointer; z-index:80;
      transition: transform .28s ease;
    }
    .refresh-btn:hover{ transform: rotate(180deg) scale(1.05) }
    .refresh-btn:focus-visible{
      outline: 4px solid var(--accent);
      outline-offset: 4px;
    }

    /* loading screen */
    .loading-screen{
      position:fixed;left:0;right:0;top:0;bottom:0;display:flex;
      align-items:center;justify-content:center;flex-direction:column;z-index:999;
      background: linear-gradient(135deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02));
      transition:opacity .28s ease, visibility .28s;
    }
    .loading-icon{ font-size:clamp(3.5rem,9vw,5rem); animation:spin 1.8s linear infinite; filter: drop-shadow(0 8px 20px rgba(0,0,0,0.18)); }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .loading-text{ margin-top:18px; font-weight:900; color:var(--accent); letter-spacing:2px; }

    /* toast */
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:92px;
      background:rgba(20,20,30,0.98); color:white;padding:12px 18px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,0.35); z-index:9999; display:inline-flex; align-items:center; gap:10px;
      opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease;
      max-width:90%; min-width:280px;
    }
    .toast.show{ opacity:1; pointer-events:auto; transform: translateX(-50%) translateY(0) }
    .toast.success{ background: linear-gradient(90deg,#2CC48A,#0EA5A1) }
    .toast.error{ background: linear-gradient(90deg,#FF6B6B,#FF8A5B); padding:14px 20px; }
    .toast button:hover{ opacity:0.9; transform:scale(1.05); }
    .toast button:focus-visible{ outline:2px solid white; outline-offset:2px; }

    /* small screens */
    @media (max-width:480px){
      .team-selector{ grid-template-columns: repeat(3, 1fr); gap:8px; padding:8px }
      .mini-card{ min-width:130px; padding:10px }
      .hero-card{ padding:18px }
      .app { padding:12px }
    }

    /* tablet / desktop adjustments */
    @media (min-width:900px){
      .team-selector{ grid-template-columns: repeat(6, 1fr) }
      .scroll-container{ padding-left:6px; }
      .app { padding:24px }
    }

    /* utility */
    .hidden{ display:none!important; }
    .fade-in{ animation: fadeIn .35s ease both }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

  </style>
</head>
<body>
  <div class="loading-screen" id="loading">
    <div class="loading-icon" id="loadingIcon">‚öæ</div>
    <div class="loading-text" id="loadingText">Â∞èÂºµÊ≠£Âú®ËßÄÊ∏¨Ê∞£Ë±°‰∏≠...</div>
  </div>

  <div class="app" id="appRoot" style="display:none;">
    <div class="status-bar" role="region" aria-label="ÁãÄÊÖãÂàó">
      <div class="location-pill" id="locationPill">üìç Ëá∫‰∏≠</div>
      <div id="updateTime" class="update-pill">Êõ¥Êñ∞‰∏≠...</div>
    </div>

    <div class="app-title">
      <h1>‚öæ Â∞èÂºµÂ†±Ê∞£Ë±° ‚öæ</h1>
      <div class="app-subtitle">WEATHER FORECAST ¬∑ CPBL STYLE</div>
    </div>

    <div class="team-selector" id="teamSelector" aria-label="ÈÅ∏ÊìáÁêÉÈöä">
      <!-- buttons Áî± JS ÊèíÂÖ• -->
    </div>

    <div id="heroCardContainer" class="fade-in">
      <!-- hero card Áî± JS ÊèíÂÖ• -->
    </div>

    <div>
      <h3 class="section-title">üìã Êú™‰æÜ 36 Â∞èÊôÇÈ†êÂ†±</h3>
      <div class="scroll-wrap">
        <div class="scroll-arrow left" id="arrowLeft">‚óÄ</div>
        <div class="scroll-arrow right" id="arrowRight">‚ñ∂</div>
        <div class="scroll-container" id="futureForecasts" tabindex="0" aria-label="Êú™‰æÜ 36 Â∞èÊôÇÈ†êÂ†±Âç°Áâá"></div>
      </div>
    </div>
  </div>

  <button class="refresh-btn hidden" id="refreshBtn" aria-label="ÈáçÊñ∞Êï¥ÁêÜ">üîÑ</button>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    /* =========================
       DATA: TEAMS
       ========================= */
    const TEAMS = {
      brothers: { name:'‰∏≠‰ø°ÂÖÑÂºü', city:'taichung', cityName:'Ëá∫‰∏≠', emoji:'üêò', primary:'#FFB81C', secondary:'#002D62', text:'#002D62' },
      lions:     { name:'Áµ±‰∏ÄÁçÖ',   city:'tainan',  cityName:'Ëá∫Âçó', emoji:'ü¶Å', primary:'#FF6600', secondary:'#1A1A1A', text:'#FFFFFF' },
      monkeys:   { name:'Ê®ÇÂ§©Ê°ÉÁåø', city:'taoyuan', cityName:'Ê°ÉÂúí', emoji:'üêµ', primary:'#C8102E', secondary:'#8B1538', text:'#FFFFFF' },
      guardians: { name:'ÂØåÈÇ¶ÊÇçÂ∞á', city:'newtaipei', cityName:'Êñ∞Âåó', emoji:'üõ°Ô∏è', primary:'#0055B8', secondary:'#003087', text:'#FFFFFF' },
      dragons:   { name:'Âë≥ÂÖ®Èæç',   city:'taipei',  cityName:'Ëá∫Âåó', emoji:'üêâ', primary:'#E4002B', secondary:'#C8102E', text:'#FFFFFF' },
      hawks:     { name:'Âè∞ÈãºÈõÑÈ∑π', city:'kaohsiung',cityName:'È´òÈõÑ', emoji:'ü¶Ö', primary:'#00695C', secondary:'#004D40', text:'#FFFFFF' }
    };

    /* =========================
       STATE
       ========================= */
    let currentTeam = localStorage.getItem('selectedTeam') || 'brothers';
    let justLoaded = true;

    /* =========================
       UTIL: THEME / CSS VARS
       ========================= */
    function applyTeamTheme(teamId) {
      const t = TEAMS[teamId];
      if(!t) return;
      document.documentElement.style.setProperty('--accent', t.primary);
      document.documentElement.style.setProperty('--accent-2', t.secondary);
      document.documentElement.style.setProperty('--accent-text', t.text);
      document.documentElement.style.setProperty('--team-emoji', `"${t.emoji}"`);
      document.documentElement.style.setProperty('--card-border', `3px solid ${t.primary}`);
      document.documentElement.style.setProperty('--loading-bg', t.primary);
      document.getElementById('locationPill').textContent = `üìç ${t.cityName}`;
      currentTeam = teamId;
      localStorage.setItem('selectedTeam', teamId);

      // loading icon color sync (small visual)
      const loadingIcon = document.getElementById('loadingIcon');
      if (loadingIcon) loadingIcon.textContent = t.emoji;
    }

    /* =========================
       RENDER: TEAM BUTTONS
       ========================= */
    const teamSelector = document.getElementById('teamSelector');
    function buildTeamButtons() {
      teamSelector.innerHTML = '';
      Object.keys(TEAMS).forEach(key => {
        const b = document.createElement('button');
        b.className = 'team-btn' + (key === currentTeam ? ' active' : '');
        b.dataset.team = key;
        b.type = 'button';
        b.innerHTML = `${TEAMS[key].emoji} ${TEAMS[key].name}`;
        
        // ÁÑ°ÈöúÁ§ôÊîπÂñÑ: Âä†ÂÖ• ARIA Â±¨ÊÄß
        b.setAttribute('role', 'button');
        b.setAttribute('aria-pressed', key === currentTeam ? 'true' : 'false');
        b.setAttribute('aria-label', `ÂàáÊèõËá≥ ${TEAMS[key].name} ${TEAMS[key].cityName} ÁöÑÂ§©Ê∞£`);
        
        // ÈªûÊìä‰∫ã‰ª∂
        const switchTeam = () => {
          if (currentTeam === key) return;
          document.querySelectorAll('.team-btn').forEach(x => {
            x.classList.remove('active');
            x.setAttribute('aria-pressed', 'false');
          });
          b.classList.add('active');
          b.setAttribute('aria-pressed', 'true');
          applyTeamTheme(key);
          showLoading(true, `ÂàáÊèõ ${TEAMS[key].name} Ë≥áÊñô‰∏≠...`);
          fetchWeather(TEAMS[key].city);
        };
        
        b.addEventListener('click', switchTeam);
        
        // ÈçµÁõ§ÊîØÊè¥: Enter Âíå Space Èçµ
        b.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            switchTeam();
          }
        });
        
        teamSelector.appendChild(b);
      });
    }

    /* =========================
       HELPERS: ICON / ADVICE / TIME
       ========================= */
    function getWeatherIcon(weather) {
      if(!weather) return "üå§Ô∏è";
      if (weather.includes("Êô¥")) return "‚òÄÔ∏è";
      if (weather.includes("Â§öÈõ≤")) return "‚õÖ";
      if (weather.includes("Èô∞")) return "‚òÅÔ∏è";
      if (weather.includes("Èõ®")) return "üåßÔ∏è";
      if (weather.includes("Èõ∑")) return "‚õàÔ∏è";
      return "üå§Ô∏è";
    }

    function getAdvice(rainProb, maxTemp) {
      let rainIcon = "üåÇ", rainText = "‰∏çÁî®Â∏∂ÂÇò";
      if (parseInt(rainProb) > 30) { rainIcon = "‚òÇÔ∏è"; rainText = "Ë®òÂæóÂ∏∂ÂÇòÔºÅ"; }

      const temp = parseInt(maxTemp);
      let clothIcon="üëï", clothText="ËàíÈÅ©Á©øÊê≠", tempAdvice="";
      if (temp >= 33) { clothIcon="üéΩ"; clothText="Ë∂ÖÁÜ±ÔºÅËÉåÂøÉ‰∏äÂ†¥"; tempAdvice="Ë®òÂæóË£úÂÖÖÊ∞¥ÂàÜ"; }
      else if (temp >= 28) { clothIcon="üëï"; clothText="Áü≠Ë¢ñÂá∫Áôº"; tempAdvice="ÈÅ©ÂêàÊà∂Â§ñÊ¥ªÂãï"; }
      else if (temp >= 23) { clothIcon="üëî"; clothText="Èï∑Ë¢ñÂâõÂâõÂ•Ω"; tempAdvice="ËàíÈÅ©ÂÆú‰∫∫"; }
      else if (temp >= 18) { clothIcon="üß•"; clothText="ËñÑÂ§ñÂ•óÂÇôËëó"; tempAdvice="Êó©ÊôöÊ∫´Â∑ÆÂ§ß"; }
      else { clothIcon="üß•"; clothText="ÂéöÂ§ñÂ•óÂøÖÂÇô"; tempAdvice="Ê≥®ÊÑè‰øùÊöñ"; }

      return { rainIcon, rainText, clothIcon, clothText, tempAdvice };
    }

    function getTimePeriod(startTime) {
      const hour = new Date(startTime).getHours();
      if (hour >= 5 && hour < 11) return "Êó©Êô®";
      if (hour >= 11 && hour < 14) return "‰∏≠Âçà";
      if (hour >= 14 && hour < 18) return "‰∏ãÂçà";
      if (hour >= 18 && hour < 23) return "Êôö‰∏ä";
      return "Ê∑±Â§ú";
    }

    /* =========================
       RENDER: HERO & MINI CARDS
       ========================= */
    function renderWeather(data) {
      const forecasts = data.forecasts;
      if(!forecasts || !forecasts.length) {
        showToast('Êâæ‰∏çÂà∞Â§©Ê∞£Ë≥áÊñô','error'); hideLoading();
        return;
      }
      const current = forecasts[0];
      const others = forecasts.slice(1);
      const advice = getAdvice(current.rain, current.maxTemp);
      const period = getTimePeriod(current.startTime);
      const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp))/2);

      // hero
      const heroHTML = `
        <div class="hero-card" role="article" aria-label="ÁõÆÂâçÂ§©Ê∞£">
          <div class="hero-period">${period}</div>
          <div class="hero-temp-container">
            <div class="hero-icon">${getWeatherIcon(current.weather)}</div>
            <div class="hero-temp">${avgTemp}¬∞</div>
          </div>
          <div class="hero-desc">${current.weather}</div>

          <div class="advice-grid">
            <div class="advice-item" aria-hidden="false">
              <div class="advice-icon">${advice.rainIcon}</div>
              <div class="advice-text">${advice.rainText}</div>
              <div class="advice-subtext">ÈôçÈõ®Ê©üÁéá ${current.rain}</div>
            </div>
            <div class="advice-item">
              <div class="advice-icon">${advice.clothIcon}</div>
              <div class="advice-text">${advice.clothText}</div>
              <div class="advice-subtext">${advice.tempAdvice}</div>
            </div>
          </div>
        </div>
      `;
      const heroContainer = document.getElementById('heroCardContainer');
      heroContainer.innerHTML = heroHTML;

      // future cards
      const scroll = document.getElementById('futureForecasts');
      scroll.innerHTML = '';
      const todayDate = new Date().getDate();

      others.forEach(f => {
        let p = getTimePeriod(f.startTime);
        const fDate = new Date(f.startTime);
        if (fDate.getDate() !== todayDate) p = "ÊòéÂ§©" + p;

        const card = document.createElement('article');
        card.className = 'mini-card';
        card.setAttribute('role', 'article');
        card.setAttribute('aria-label', `${p} Â§©Ê∞£: ${f.weather}, Ê∫´Â∫¶ ${f.minTemp} Ëá≥ ${f.maxTemp} Â∫¶, ÈôçÈõ®Ê©üÁéá ${f.rain}`);
        card.innerHTML = `
          <div class="mini-time">${p}</div>
          <div class="mini-icon" aria-hidden="true">${getWeatherIcon(f.weather)}</div>
          <div class="mini-temp">${f.minTemp}¬∞ - ${f.maxTemp}¬∞</div>
          <div class="mini-rain">üíß ${f.rain}</div>
        `;
        scroll.appendChild(card);
      });

      // update time text
      const now = new Date();
      const month = now.getMonth() + 1;
      const date = now.getDate();
      const days = ["ÈÄ±Êó•","ÈÄ±‰∏Ä","ÈÄ±‰∫å","ÈÄ±‰∏â","ÈÄ±Âõõ","ÈÄ±‰∫î","ÈÄ±ÂÖ≠"];
      document.getElementById('updateTime').textContent = `${month}Êúà${date}Êó• ${days[now.getDay()]}`;

      showToast('Êõ¥Êñ∞ÂÆåÊàê ‚úîÔ∏è','success');
    }

    /* =========================
       API CACHE SYSTEM
       ========================= */
    class WeatherCache {
      constructor(duration = 10 * 60 * 1000) { // 10ÂàÜÈêòÂø´Âèñ
        this.duration = duration;
        this.cache = new Map();
      }

      get(key) {
        const item = this.cache.get(key);
        if (!item) return null;
        
        if (Date.now() - item.timestamp > this.duration) {
          this.cache.delete(key);
          return null;
        }
        
        return item.data;
      }

      set(key, data) {
        this.cache.set(key, {
          data,
          timestamp: Date.now()
        });
      }

      clear() {
        this.cache.clear();
      }

      has(key) {
        const item = this.cache.get(key);
        if (!item) return false;
        return (Date.now() - item.timestamp) <= this.duration;
      }
    }

    const weatherCache = new WeatherCache();

    /* =========================
       ERROR HANDLING
       ========================= */
    class WeatherError extends Error {
      constructor(message, code, details = null) {
        super(message);
        this.name = 'WeatherError';
        this.code = code;
        this.details = details;
      }
    }

    function getErrorMessage(error) {
      if (error instanceof WeatherError) {
        switch(error.code) {
          case 'OFFLINE':
            return 'Á∂≤Ë∑ØÈÄ£Á∑ö‰∏≠Êñ∑ÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÂæåÂÜçË©¶';
          case 'TIMEOUT':
            return 'Ë´ãÊ±ÇÈÄæÊôÇÔºåË´ãÁ®çÂæåÂÜçË©¶';
          case 'API_ERROR':
            return 'Â§©Ê∞£Ë≥áÊñôËÆÄÂèñÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶';
          case 'NO_DATA':
            return 'Êâæ‰∏çÂà∞Â§©Ê∞£Ë≥áÊñô';
          default:
            return error.message;
        }
      }
      return 'ÁôºÁîüÊú™Áü•ÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶';
    }

    /* =========================
       FETCH: Weather API
       ========================= */
    async function fetchWeather(city, forceRefresh = false, retryCount = 0) {
      const MAX_RETRIES = 2;
      
      try {
        // Ê™¢Êü•Âø´Âèñ
        if (!forceRefresh) {
          const cached = weatherCache.get(city);
          if (cached) {
            console.log('‰ΩøÁî®Âø´ÂèñË≥áÊñô:', city);
            renderWeather(cached);
            hideLoading();
            showRefresh(true);
            showToast('Â∑≤ËºâÂÖ•Âø´ÂèñË≥áÊñô ‚ö°','success', 1500);
            return;
          }
        }

        // Ê™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö
        if (!navigator.onLine) {
          throw new WeatherError('Á∂≤Ë∑ØÈÄ£Á∑ö‰∏≠Êñ∑', 'OFFLINE');
        }

        // Â¶ÇÊûúÊ≤íÊúâÂø´ÂèñÊàñÂº∑Âà∂Âà∑Êñ∞,ÂâáÁôºÈÄÅ API Ë´ãÊ±Ç
        const API_URL = `https://weather-cpbl.zeabur.app/api/weather/${city}`;
        const delay = new Promise(res => setTimeout(res, 800));
        
        // Âä†ÂÖ•ÈÄæÊôÇÊéßÂà∂
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ÁßíÈÄæÊôÇ
        
        const fetcher = fetch(API_URL, { signal: controller.signal })
          .then(r => {
            clearTimeout(timeoutId);
            if(!r.ok) {
              if (r.status >= 500) {
                throw new WeatherError('‰º∫ÊúçÂô®ÈåØË™§', 'API_ERROR', { status: r.status });
              } else if (r.status === 404) {
                throw new WeatherError('Êâæ‰∏çÂà∞Ë≥áÊñô', 'NO_DATA');
              } else {
                throw new WeatherError('Á∂≤Ë∑ØÈåØË™§', 'API_ERROR', { status: r.status });
              }
            }
            return r.json();
          })
          .catch(err => {
            clearTimeout(timeoutId);
            if (err.name === 'AbortError') {
              throw new WeatherError('Ë´ãÊ±ÇÈÄæÊôÇ', 'TIMEOUT');
            }
            throw err;
          });
        
        const [_, json] = await Promise.all([delay, fetcher]);

        if (json && json.success) {
          // ÂÑ≤Â≠òÂà∞Âø´Âèñ
          weatherCache.set(city, json.data);
          console.log('Â∑≤ÂÑ≤Â≠òÂà∞Âø´Âèñ:', city);
          
          renderWeather(json.data);
          hideLoading();
          showRefresh(true);
        } else {
          throw new WeatherError('API ÂõûÂÇ≥ÁÑ°ÊïàË≥áÊñô', 'NO_DATA');
        }
      } catch (err) {
        console.error('Â§©Ê∞£Ë≥áÊñôËÆÄÂèñÈåØË™§:', err);
        
        // ÈáçË©¶Ê©üÂà∂
        if (retryCount < MAX_RETRIES && err.code !== 'NO_DATA') {
          console.log(`ÈáçË©¶Á¨¨ ${retryCount + 1} Ê¨°...`);
          showToast(`ÈáçË©¶‰∏≠... (${retryCount + 1}/${MAX_RETRIES})`, 'info', 1500);
          await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // ÊåáÊï∏ÈÄÄÈÅø
          return fetchWeather(city, forceRefresh, retryCount + 1);
        }
        
        hideLoading();
        showRefresh(true);
        
        // È°ØÁ§∫ÈåØË™§Ë®äÊÅØÂíåÈáçË©¶ÊåâÈàï
        const errorMsg = getErrorMessage(err);
        showErrorWithRetry(errorMsg, () => {
          showLoading(true, 'ÈáçÊñ∞ËºâÂÖ•...');
          showRefresh(false);
          fetchWeather(city, true);
        });
      }
    }

    /* =========================
       LOADING & REFRESH UI
       ========================= */
    function showLoading(show=true, text) {
      const L = document.getElementById('loading');
      const app = document.getElementById('appRoot');
      if (show) {
        L.style.display = 'flex';
        if (text) document.getElementById('loadingText').textContent = text;
        app.style.display = 'none';
      } else {
        L.style.display = 'none';
        app.style.display = '';
      }
    }
    function hideLoading(){ showLoading(false); }

    function showRefresh(show=true){
      const btn = document.getElementById('refreshBtn');
      if (show) btn.classList.remove('hidden'); else btn.classList.add('hidden');
    }

    /* =========================
       ERROR DISPLAY WITH RETRY
       ========================= */
    function showErrorWithRetry(message, retryCallback) {
      const t = document.getElementById('toast');
      t.className = 'toast error';
      t.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
          <span>${message}</span>
          <button 
            onclick="this.parentElement.parentElement.classList.remove('show'); arguments[0].retryFn();" 
            style="background:white; color:#e53e3e; border:none; padding:6px 12px; border-radius:8px; font-weight:900; cursor:pointer; font-size:0.9rem;"
            aria-label="ÈáçË©¶ËºâÂÖ•Â§©Ê∞£Ë≥áÊñô"
          >
            üîÑ ÈáçË©¶
          </button>
        </div>
      `;
      
      // ÂÑ≤Â≠ò callback Âà∞ event Áâ©‰ª∂‰∏≠
      const btn = t.querySelector('button');
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        t.classList.remove('show');
        retryCallback();
      });
      
      setTimeout(() => { t.classList.add('show'); }, 20);
      
      // ‰∏çËá™ÂãïÊ∂àÂ§±ÔºåÈúÄË¶ÅÁî®Êà∂‰∏ªÂãïÈóúÈñâÊàñÈªûÊìäÈáçË©¶
    }

    /* =========================
       TOAST
       ========================= */
    let toastTimer = null;
    function showToast(message, type='info', duration=2500) {
      const t = document.getElementById('toast');
      t.className = 'toast';
      t.textContent = message;
      if (type === 'success') t.classList.add('success');
      if (type === 'error') t.classList.add('error');
      // show
      setTimeout(()=>{ t.classList.add('show'); }, 20);
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ t.classList.remove('show'); }, duration);
    }

    /* =========================
       SCROLL ARROW HINTS
       ========================= */
    const scrollContainer = document.getElementById('futureForecasts');
    const arrowLeft = document.getElementById('arrowLeft');
    const arrowRight = document.getElementById('arrowRight');
    function updateArrows() {
      if (!scrollContainer) return;
      const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
      if (maxScroll > 10) {
        arrowLeft.classList.add('visible');
        arrowRight.classList.add('visible');
        setTimeout(()=>{ arrowLeft.classList.remove('visible'); arrowRight.classList.remove('visible'); }, 2500);
      } else {
        arrowLeft.classList.remove('visible');
        arrowRight.classList.remove('visible');
      }
    }
    // allow keyboard scrolling
    if (scrollContainer) {
      scrollContainer.addEventListener('keydown', (e)=>{
        if(e.key === 'ArrowRight') scrollContainer.scrollBy({ left: 160, behavior:'smooth' });
        if(e.key === 'ArrowLeft') scrollContainer.scrollBy({ left:-160, behavior:'smooth' });
      });
    }

    /* =========================
       GELOCATION AUTO-SWITCH
       ========================= */
    function mapCoordsToTeam(lat, lng) {
      // ÈùûÂö¥Ê†ºÔºöÁî®Á∞°ÂñÆÁ∂ìÁ∑ØÂ∫¶ÂçÄÂüüÂäÉÂàÜÂè∞ÁÅ£‰∏ªË¶ÅÈÉΩÂ∏ÇÁØÑÂúç
      // Âè∞ÁÅ£Â§ßËá¥Á∂ìÁ∑ØÂ∫¶ÁØÑÂúçÔºölat 21.7 - 25.3, lng 119.5 - 122
      // ‰ª•‰∏ªË¶ÅÂüéÂ∏ÇÁØÑÂúçÂà§Êñ∑
      if (!lat || !lng) return null;
      // Kaohsiung (È´òÈõÑ)
      if (lat < 23.0 && lng > 120.2) return 'hawks';
      // Tainan (Âè∞Âçó)
      if (lat < 23.5 && lng > 120.0 && lng < 120.6) return 'lions';
      // Taichung (Âè∞‰∏≠)
      if (lat >= 23.8 && lat < 24.7 && lng >= 120.4 && lng < 121.0) return 'brothers';
      // Taoyuan (Ê°ÉÂúí)
      if (lat >= 24.8 && lat < 25.2 && lng >= 121.0 && lng < 121.3) return 'monkeys';
      // NewTaipei (Êñ∞Âåó)
      if (lat >= 24.9 && lat < 25.3 && lng >= 121.3 && lng < 121.6) return 'guardians';
      // Taipei
      if (lat >= 25.0 && lat < 25.4 && lng >= 121.4 && lng < 121.6) return 'dragons';
      // fallback
      return 'brothers';
    }

    function tryGeolocation() {
      if (!navigator.geolocation) return Promise.resolve(null);
      return new Promise(resolve => {
        const geoTimeout = setTimeout(()=> resolve(null), 4000); // 4s timeout
        navigator.geolocation.getCurrentPosition((pos) => {
          clearTimeout(geoTimeout);
          const { latitude:lat, longitude:lng } = pos.coords;
          const team = mapCoordsToTeam(lat,lng);
          resolve({lat,lng,team});
        }, (err)=> {
          clearTimeout(geoTimeout);
          resolve(null);
        }, { enableHighAccuracy:false, maximumAge:600000, timeout:3500 });
      });
    }

    /* =========================
       INIT
       ========================= */
    async function init() {
      applyTeamTheme(currentTeam);
      buildTeamButtons();
      showLoading(true, 'Â∞èÂºµÊ≠£Âú®ËßÄÊ∏¨Ê∞£Ë±°‰∏≠...');

      // try geolocation on first load only
      if (justLoaded) {
        const geo = await tryGeolocation();
        if (geo && geo.team) {
          // if geolocated team differs from saved, switch
          if (geo.team !== currentTeam) {
            applyTeamTheme(geo.team);
            document.querySelectorAll('.team-btn').forEach(b => b.classList.toggle('active', b.dataset.team === geo.team));
            showLoading(true, `‰æùÂÆö‰ΩçÂàáÊèõËá≥ ${TEAMS[geo.team].name}...`);
            await fetchWeather(TEAMS[geo.team].city);
            justLoaded = false;
            document.getElementById('appRoot').style.display = '';
            return;
          }
        }
      }

      // default fetch
      await fetchWeather(TEAMS[currentTeam].city);
      document.getElementById('appRoot').style.display = '';
      showRefresh(true);
      updateArrows();
      justLoaded = false;
    }

    /* =========================
       EVENT: refresh button
       ========================= */
    document.getElementById('refreshBtn').addEventListener('click', ()=>{
      showLoading(true,'Êõ¥Êñ∞‰∏≠...');
      showRefresh(false);
      fetchWeather(TEAMS[currentTeam].city, true); // Âº∑Âà∂Âà∑Êñ∞Ôºå‰∏ç‰ΩøÁî®Âø´Âèñ
    });

    /* =========================
       ARROW CLICK (scroll)
       ========================= */
    arrowLeft.addEventListener('click', ()=> {
      scrollContainer.scrollBy({ left:-160, behavior:'smooth' });
    });
    arrowRight.addEventListener('click', ()=> {
      scrollContainer.scrollBy({ left:160, behavior:'smooth' });
    });

    // show arrows briefly on any scrollable content change
    const observer = new MutationObserver(()=> updateArrows());
    observer.observe(document.getElementById('futureForecasts'), { childList:true, subtree:true });

    // initial DOM prepared
    buildTeamButtons();

    // finally run init
    init();

    // small accessibility: hide loading after heavy delay in case something fails visually
    setTimeout(()=> {
      const L = document.getElementById('loading');
      if (L && L.style.display !== 'none') {
        // if still visible long after init, keep it but show toast
        showToast('Á≠âÂæÖË≥áÊñô‰∏≠...', 'info');
      }
    }, 7000);

  </script>
</body>
</html>